<!DOCTYPE html>
<html>
<head>
    <title>Sitemap Generator API</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .status { padding: 15px; margin: 20px 0; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .loading { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow: auto; font-size: 12px; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>Dynamic Sitemap Generator</h1>
    
    <div id="status" class="status loading">
        <strong>Status:</strong> Initializing...
    </div>

    <div id="content" style="display: none;">
        <h3>Generated Sitemap Preview:</h3>
        <pre id="preview"></pre>
        
        <div>
            <button class="btn" onclick="downloadSitemap()">Download Sitemap</button>
            <button class="btn" onclick="copyToClipboard()">Copy XML</button>
            <button class="btn" onclick="regenerate()">Regenerate</button>
        </div>
    </div>

    <div style="margin-top: 30px; font-size: 14px; color: #666;">
        <h3>API Usage:</h3>
        <p><strong>For JSON response:</strong> Add <code>?format=json</code> to the URL</p>
        <p><strong>Current endpoint:</strong> <code id="current-url"></code></p>
        <p><strong>JSON endpoint:</strong> <code id="json-url"></code></p>
        
        <h4>N8N Integration:</h4>
        <ul>
            <li>Method: GET</li>
            <li>URL: <span id="api-url"></span></li>
            <li>Expected response: JSON with status, message, timestamp</li>
        </ul>
        
        <h4>Google Search Console Submission:</h4>
        <p>After sitemap generation, submit to Google Search Console:</p>
        <p><code>https://alemara.co.uk/sitemap.xml</code></p>
    </div>

    <script>
        let currentSitemap = '';
        
        // Set URLs
        const currentUrl = window.location.href;
        const jsonUrl = currentUrl + '?format=json';
        const apiUrl = jsonUrl;
        
        document.getElementById('current-url').textContent = currentUrl;
        document.getElementById('json-url').textContent = jsonUrl;
        document.getElementById('api-url').textContent = apiUrl;

        // Check if JSON format is requested
        const urlParams = new URLSearchParams(window.location.search);
        const isJsonFormat = urlParams.get('format') === 'json';

        async function generateSitemap() {
            try {
                const SITE_URL = 'https://alemara.co.uk';
                
                // Static routes
                const staticRoutes = [
                    '/', '/about-us', '/services', '/services/residential', '/services/loft-conversions',
                    '/services/residential/loft-conversions', '/services/extensions', '/services/residential/extensions',
                    '/services/structural-surveys', '/services/commercial', '/services/civil-engineering',
                    '/services/basement-extensions', '/services/subsidence-crack-surveys', '/services/new-builds',
                    '/areas/islington-highbury', '/areas/camden-kentish-town', '/areas/hackney-shoreditch',
                    '/areas/kensington-chelsea', '/areas/westminster-mayfair', '/areas/london-boroughs',
                    '/portfolio', '/faq', '/contact', '/privacy-policy', '/terms', '/blog',
                ];

                // Portfolio projects (using the actual slugs from your data)
                const portfolioProjects = [
                    'residential-extension-islington', 'loft-conversion-camden', 'basement-extension-kensington',
                    'commercial-office-refurbishment', 'victorian-house-structural-assessment', 'period-property-survey-chelsea',
                    'new-build-residential-development', 'structural-calculations-planning', 'party-wall-assessment-london',
                    'subsidence-investigation-report', 'hinkley-point-c-nuclear-power-station', 'hs2-high-speed-rail-infrastructure'
                ];

                // Fetch blog posts from Supabase
                const SUPABASE_URL = 'https://alwjzubhrjubtvwenyqt.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsd2p6dWJocmp1YnR2d2VueXF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDI4NjA1NTQsImV4cCI6MjA1ODQzNjU1NH0.QQxZvC1par1hFfudWIoLuqpA8Ji50-vAZA4QHWMayds';
                
                let blogPosts = [];
                try {
                    const blogResponse = await fetch(`${SUPABASE_URL}/rest/v1/blogs?published=eq.true&order=date_published.desc`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (blogResponse.ok) {
                        blogPosts = await blogResponse.json();
                    }
                } catch (error) {
                    console.warn('Could not fetch blog posts:', error.message);
                }

                const urls = [];
                const today = new Date().toISOString().slice(0, 10);

                const urlEl = ({ loc, lastmod, changefreq = 'monthly', priority = '0.7' }) => {
                    return `  <url>
    <loc>${loc}</loc>
    ${lastmod ? `<lastmod>${lastmod}</lastmod>` : ''}
    <changefreq>${changefreq}</changefreq>
    <priority>${priority}</priority>
  </url>`;
                };

                // Static pages
                for (const route of staticRoutes) {
                    urls.push(urlEl({ 
                        loc: `${SITE_URL}${route}`, 
                        lastmod: today, 
                        priority: route === '/' ? '1.0' : '0.8' 
                    }));
                }

                // Portfolio pages
                for (const project of portfolioProjects) {
                    urls.push(urlEl({ 
                        loc: `${SITE_URL}/portfolio/${project}`, 
                        lastmod: today, 
                        priority: '0.7' 
                    }));
                }

                // Blog posts
                for (const post of blogPosts) {
                    const lastmod = post.updated_at || post.date_published || today;
                    urls.push(urlEl({ 
                        loc: `${SITE_URL}/blog/${post.slug}`, 
                        lastmod: new Date(lastmod).toISOString().slice(0, 10), 
                        priority: '0.6', 
                        changefreq: 'weekly' 
                    }));
                }

                const xml = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
${urls.join('\n')}
</urlset>`;

                currentSitemap = xml;

                const result = {
                    status: 'success',
                    message: `Sitemap generated successfully with ${urls.length} URLs (${blogPosts.length} blog posts included)`,
                    timestamp: new Date().toISOString(),
                    sitemap_length: xml.length,
                    urls_count: urls.length,
                    blog_posts_count: blogPosts.length
                };

                return result;

            } catch (error) {
                console.error('Error generating sitemap:', error);
                return {
                    status: 'error',
                    message: error.message,
                    timestamp: new Date().toISOString()
                };
            }
        }

        function downloadSitemap() {
            if (!currentSitemap) return;
            
            const blob = new Blob([currentSitemap], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sitemap.xml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            if (!currentSitemap) return;
            
            navigator.clipboard.writeText(currentSitemap).then(() => {
                alert('Sitemap XML copied to clipboard!');
            });
        }

        function regenerate() {
            location.reload();
        }

        // Initialize
        async function init() {
            const result = await generateSitemap();
            
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${result.status}`;
            statusEl.innerHTML = `<strong>Status:</strong> ${result.status}<br><strong>Message:</strong> ${result.message}`;

            if (isJsonFormat) {
                // Return JSON response
                document.body.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            } else if (result.status === 'success') {
                document.getElementById('content').style.display = 'block';
                document.getElementById('preview').textContent = currentSitemap.substring(0, 1000) + '...';
                
                // Auto-download the sitemap
                setTimeout(downloadSitemap, 1000);
            }
        }

        // Start generation
        init();
    </script>
</body>
</html> 